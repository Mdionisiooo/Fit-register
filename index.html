<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Tracker Mobile App</title>
    <!-- REFER√äNCIA AO MANIFESTO PWA (NOVA LINHA) -->
    <link rel="manifest" href="./manifest.json">
    <!-- Incluindo Tailwind CSS para estiliza√ß√£o moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluindo Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Configura√ß√£o de cores e fontes do Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#059669', // Verde Esmeralda Suave
                        'primary-light': '#D1FAE5',
                        'background': '#F9FAFB', // Fundo super clean
                        'card-bg': '#FFFFFF',
                        'text-default': '#1F2937',
                        'weight-color': '#3B82F6', // Azul para peso
                        'calorie-color': '#F59E0B', // Amarelo para calorias
                        'strength-color': '#9333EA', // Roxo para forca (PR)
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Incluindo a fonte Inter (usada por padr√£o no Tailwind, mas bom garantir) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Estilos espec√≠ficos para simular o container de um app mobile */
        body {
            background-color: '#E5E7EB'; /* Cinza claro fora do "celular" */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }

        /* O wrapper principal simula a tela do celular */
        #app-container {
            width: 100%;
            max-width: 420px; /* Largura m√°xima t√≠pica de um smartphone */
            min-height: 100vh;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            position: relative;
            background-color: '#F9FAFB';
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Estilo da √°rea de conte√∫do (rol√°vel) */
        #content-area {
            flex-grow: 1;
            padding: 16px;
            padding-bottom: 80px; /* Espa√ßo para a barra de navega√ß√£o inferior */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* Suavidade no scroll em iOS */
        }

        /* Estilos para o bot√£o de navega√ß√£o ativo */
        .nav-icon.active {
            color: '#059669'; /* primary */
            transform: scale(1.1);
        }

        /* Transi√ß√£o suave para abas */
        .tab-content {
            transition: opacity 0.3s ease-in-out;
        }
        
        .form-message-placeholder {
            min-height: 1.5rem; /* Garante que a √°rea de mensagem n√£o colapse */
        }
    </style>
</head>
<body class="bg-gray-100">

<div id="app-container">

    <!-- Cabe√ßalho (Fixo) -->
    <header class="bg-white p-4 shadow-sm z-10 flex justify-between items-center sticky top-0">
        <h1 class="text-xl font-bold text-text-default">Fitness Tracker</h1>
        <div id="daily-date" class="text-primary font-medium text-sm rounded-full bg-primary-light px-3 py-1 shadow-sm">
            <!-- Data atual ser√° inserida aqui -->
        </div>
    </header>

    <!-- √Årea de Conte√∫do (Vari√°vel por Aba) -->
    <main id="content-area">
        <!-- Resumo Di√°rio (Vis√≠vel em todas as abas, exceto Settings) -->
        <div id="daily-summary" class="mb-6 p-4 bg-card-bg rounded-xl shadow-md border-t-4 border-primary">
            <h2 class="text-lg font-semibold text-text-default mb-2">Resumo Di√°rio</h2>
            <div id="summary-grid" class="grid grid-cols-2 gap-3 text-sm">
                <!-- Conte√∫do do resumo (calorias, macros e treino) ser√° injetado pelo JS -->
            </div>
        </div>

        <!-- ABA 1: TREINOS -->
        <div id="tab-workouts" class="tab-content" style="display: none;">
            <h2 class="text-2xl font-bold text-text-default mb-4">Treinos üí™</h2>
            
            <!-- SELE√á√ÉO DE DATA PARA TREINOS -->
            <div class="mb-4 flex items-center">
                <label for="workout-date-select" class="text-sm font-medium text-gray-700 mr-2">Visualizar Data:</label>
                <input type="date" id="workout-date-select" class="p-2 border border-gray-300 rounded-lg text-sm flex-grow">
            </div>

            <div id="workouts-log" class="space-y-4 mb-6">
                <!-- Treinos registrados ser√£o renderizados aqui -->
            </div>

            <!-- Formul√°rio para Adicionar Exerc√≠cio -->
            <div class="p-4 bg-card-bg rounded-xl shadow-md">
                <h3 class="text-lg font-semibold mb-3 border-b pb-2">Adicionar Novo Exerc√≠cio</h3>
                <form id="add-exercise-form" class="space-y-3">
                    
                    <!-- Sele√ß√£o de Categoria -->
                    <select id="exercise-category" required 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">Selecione a Categoria</option>
                        <!-- Op√ß√µes ser√£o carregadas via JS -->
                    </select>

                    <!-- Sele√ß√£o de Exerc√≠cio (Dependente da Categoria) -->
                    <select id="exercise-name" required disabled
                           class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">Selecione o Exerc√≠cio</option>
                    </select>

                    <!-- NOVO: Exibi√ß√£o do √öltimo PR/Registro -->
                    <div id="last-pr-display" class="text-center">
                        <span class="text-xs text-gray-400">Selecione o exerc√≠cio para carregar o √∫ltimo registro.</span>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2">
                        <input type="number" id="exercise-sets" placeholder="S√©ries" required min="1"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        <input type="number" id="exercise-reps" placeholder="Repeti√ß√µes" required min="1"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        <input type="number" id="exercise-load" placeholder="Carga (kg)" required min="0" value="0"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <button type="submit"
                            class="w-full bg-primary text-white p-3 rounded-xl font-semibold shadow-lg hover:bg-opacity-90 transition duration-150">
                        + Registrar Treino
                    </button>
                    <!-- Placeholder de Mensagem de Erro/Sucesso -->
                    <p id="exercise-form-message" class="text-sm mt-2 text-center form-message-placeholder"></p>
                </form>
            </div>
        </div>

        <!-- ABA 2: ALIMENTA√á√ÉO -->
        <div id="tab-food" class="tab-content" style="display: none;">
            <h2 class="text-2xl font-bold text-text-default mb-4">Alimenta√ß√£o üçé</h2>

            <!-- Sele√ß√£o da Data -->
            <div class="mb-4 flex items-center">
                <label for="food-date-select" class="text-sm font-medium text-gray-700 mr-2">Visualizar Data:</label>
                <input type="date" id="food-date-select" class="p-2 border border-gray-300 rounded-lg text-sm flex-grow">
            </div>

            <!-- Template Loader e Bot√£o de Gerenciamento -->
            <div class="p-4 bg-card-bg rounded-xl shadow-md mb-4 border-l-4 border-strength-color">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold text-strength-color">Carregar Template</h3>
                    <button id="open-template-manager" type="button" 
                            class="text-xs bg-gray-100 text-gray-700 px-3 py-1 rounded-lg font-medium hover:bg-gray-200 transition duration-150">
                        Gerenciar Pratos
                    </button>
                </div>
                
                <form id="load-template-form" class="space-y-3">
                    <select id="template-selector" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-strength-color">
                        <option value="">Selecione um Prato Salvo</option>
                        <!-- Templates ser√£o injetados aqui -->
                    </select>
                    <button type="submit"
                            class="w-full bg-strength-color text-white p-3 rounded-xl font-semibold shadow-lg hover:bg-opacity-90 transition duration-150">
                        Carregar na Refei√ß√£o
                    </button>
                </form>
            </div>
            
            <div id="food-log" class="space-y-4 mb-6">
                <!-- Refei√ß√µes e subtotais ser√£o renderizados aqui -->
            </div>

            <!-- Formul√°rio para Adicionar Refei√ß√£o/Alimento -->
            <div class="p-4 bg-card-bg rounded-xl shadow-md mb-4">
                <h3 class="text-lg font-semibold mb-3 border-b pb-2">Registrar Refei√ß√£o</h3>
                <form id="add-meal-form" class="space-y-3">
                    <select id="meal-type" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">Selecione a Refei√ß√£o</option>
                        <option value="Caf√© da Manh√£">Caf√© da Manh√£</option>
                        <option value="Almo√ßo">Almo√ßo</option>
                        <option value="Jantar">Jantar</option>
                        <option value="Lanche">Lanche/Outros</option>
                    </select>
                    
                    <!-- Busca e Quantidade -->
                    <input type="text" id="food-name-input" placeholder="Buscar Alimento (ex: Frango)" required list="food-list"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    <datalist id="food-list">
                        <!-- Op√ß√µes de alimentos da base de dados (FOOD_DATABASE) ser√£o injetadas aqui -->
                    </datalist>

                    <input type="number" id="food-quantity" placeholder="Quantidade (g/unidades)" required min="1" value="100"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    
                    <!-- Visualiza√ß√£o de C√°lculo Autom√°tico -->
                    <div id="food-preview" class="p-3 bg-primary-light rounded-lg text-sm border border-primary">
                        <p class="font-semibold text-text-default mb-1">Estimativa de Macros (Calculado):</p>
                        <p id="preview-calories" class="text-xl font-extrabold text-primary">0 kcal</p>
                        <p class="text-xs text-gray-700">P: <span id="preview-protein">0</span>g | C: <span id="preview-carbs">0</span>g | G: <span id="preview-fats">0</span>g</p>
                    </div>

                    <button type="submit"
                            class="w-full bg-primary text-white p-3 rounded-xl font-semibold shadow-lg hover:bg-opacity-90 transition duration-150">
                        + Adicionar Refei√ß√£o
                    </button>
                    <!-- Placeholder de Mensagem de Erro/Sucesso -->
                    <p id="meal-form-message" class="text-sm mt-2 text-center form-message-placeholder"></p>
                </form>
            </div>
            
            <!-- NOVO FORMUL√ÅRIO: Adicionar Alimento Manualmente -->
            <div class="p-4 bg-card-bg rounded-xl shadow-md border-t-4 border-calorie-color">
                <h3 class="text-lg font-semibold mb-3 border-b pb-2 text-calorie-color">Criar Novo Alimento</h3>
                <form id="add-custom-food-form" class="space-y-3">
                    <input type="text" id="custom-food-name" placeholder="Nome do Alimento (ex: Whey Caseiro)" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-calorie-color">
                    
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" id="custom-food-calories" placeholder="Kcal / 100g" required min="0"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-calorie-color">
                        <input type="text" id="custom-food-unit" value="g" placeholder="Unidade (ex: g, mL)" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-calorie-color">
                    </div>

                    <div class="grid grid-cols-3 gap-2">
                        <input type="number" id="custom-food-protein" placeholder="Prote√≠na (g) / 100g" required min="0" step="0.1"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-calorie-color">
                        <input type="number" id="custom-food-carbs" placeholder="Carbo (g) / 100g" required min="0" step="0.1"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-calorie-color">
                        <input type="number" id="custom-food-fats" placeholder="Gordura (g) / 100g" required min="0" step="0.1"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-calorie-color">
                    </div>
                    <button type="submit"
                            class="w-full bg-calorie-color text-white p-3 rounded-xl font-semibold shadow-lg hover:bg-opacity-90 transition duration-150">
                        + Salvar Alimento
                    </button>
                </form>
                <p id="custom-food-message" class="text-xs mt-2 text-center form-message-placeholder"></p>
            </div>
        </div>

        <!-- ABA 3: PROGRESSO -->
        <div id="tab-progress" class="tab-content" style="display: none;">
            <h2 class="text-2xl font-bold text-text-default mb-4">Progresso üìà</h2>

            <!-- Input de Peso Corporal COM SELETOR DE DATA -->
            <div class="p-4 bg-card-bg rounded-xl shadow-md mb-6">
                <h3 class="text-lg font-semibold mb-2">Acompanhamento de Peso</h3>
                <form id="add-weight-form" class="space-y-3">
                    <div class="flex gap-2 items-center">
                        <label for="weight-date-select" class="text-sm font-medium text-gray-700 mr-2">Data do Peso:</label>
                        <input type="date" id="weight-date-select" class="p-2 border border-gray-300 rounded-lg text-sm flex-grow">
                    </div>
                    <div class="flex gap-2 items-center">
                        <input type="number" id="current-weight" placeholder="Seu peso (kg)" required min="30" step="0.1"
                               class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        <button type="submit"
                                class="bg-primary text-white p-3 rounded-lg font-semibold hover:bg-opacity-90 transition duration-150">
                            Registrar
                        </button>
                    </div>
                </form>
                
                <!-- Exibi√ß√£o do peso para a data selecionada -->
                <div id="selected-weight-display" class="mt-4 border-t pt-3 text-lg font-bold text-center">
                    <!-- Peso para a data selecionada ser√° exibido aqui -->
                </div>
            </div>

            <!-- Gr√°ficos Reais -->
            <div class="space-y-6">
                
                <!-- Gr√°fico de Evolu√ß√£o de For√ßa (NOVO) -->
                <div class="p-4 bg-card-bg rounded-xl shadow-md">
                    <h3 class="text-lg font-semibold mb-2 text-strength-color">Evolu√ß√£o de For√ßa (PR)</h3>
                    <div class="mb-3">
                        <select id="strength-exercise-select" 
                               class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-strength-color">
                            <option value="">Selecione um Exerc√≠cio...</option>
                            <!-- Op√ß√µes ser√£o carregadas via JS -->
                        </select>
                    </div>
                    <p id="current-pr-display" class="text-sm text-gray-600 mb-2 font-medium text-center">PR Atual: -</p>
                    <div class="h-64">
                        <canvas id="strengthChart"></canvas>
                    </div>
                </div>

                <div class="p-4 bg-card-bg rounded-xl shadow-md">
                    <h3 class="text-lg font-semibold mb-2 text-weight-color">Evolu√ß√£o de Peso</h3>
                    <div class="h-64">
                        <canvas id="weightChart"></canvas>
                    </div>
                </div>

                <div class="p-4 bg-card-bg rounded-xl shadow-md">
                    <h3 class="text-lg font-semibold mb-2 text-calorie-color">Balan√ßo Cal√≥rico (√öltimos 30 dias)</h3>
                    <div class="h-64">
                        <canvas id="calorieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA 4: CONFIGURA√á√ïES -->
        <div id="tab-settings" class="tab-content" style="display: none;">
            <h2 class="text-2xl font-bold text-text-default mb-4">Configura√ß√µes ‚öôÔ∏è</h2>

            <!-- NOVO: DEFINIR METAS DE MACROS -->
            <div class="p-4 bg-card-bg rounded-xl shadow-md mb-6 border-l-4 border-blue-500">
                <h3 class="text-xl font-semibold mb-3 text-blue-700">Metas de Macronutrientes (g)</h3>
                
                <form id="set-macro-goal-form" class="space-y-3">
                    <input type="number" id="protein-goal-input" placeholder="Meta de Prote√≠na (g)" required min="10"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="number" id="carbs-goal-input" placeholder="Meta de Carboidrato (g)" required min="10"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="number" id="fats-goal-input" placeholder="Meta de Gordura (g)" required min="5"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit"
                            class="w-full bg-blue-500 text-white p-3 rounded-xl font-semibold shadow-lg hover:bg-blue-600 transition duration-150">
                        Salvar Metas de Macros
                    </button>
                </form>
                <p id="macro-goal-message" class="mt-3 text-sm font-bold text-center">P: - | C: - | G: -</p>
            </div>

            <!-- CALCULAR TDEE -->
            <div class="p-4 bg-card-bg rounded-xl shadow-md mb-6 border-l-4 border-green-500">
                <h3 class="text-xl font-semibold mb-3 text-green-700">Calculadora de Gasto Cal√≥rico (TDEE)</h3>
                <form id="tdee-calculator-form" class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <select id="calc-gender" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="">G√™nero</option>
                            <option value="male">Masculino</option>
                            <option value="female">Feminino</option>
                        </select>
                        <input type="number" id="calc-age" placeholder="Idade (anos)" required min="15" max="100"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="calc-height" placeholder="Altura (cm)" required min="100"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        <input type="number" id="calc-weight" placeholder="Peso (kg)" required min="30" step="0.1"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <select id="calc-activity" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">N√≠vel de Atividade</option>
                        <option value="1.2">Sedent√°rio (Pouco/Nenhum exerc√≠cio)</option>
                        <option value="1.375">Leve (1-3 dias/semana)</option>
                        <option value="1.55">Moderado (3-5 dias/semana)</option>
                        <option value="1.725">Intenso (6-7 dias/semana)</option>
                        <option value="1.9">Extremo (Di√°rio + trabalho f√≠sico)</option>
                    </select>

                    <button type="submit"
                            class="w-full bg-green-500 text-white p-3 rounded-xl font-semibold shadow-lg hover:bg-green-600 transition duration-150">
                        Calcular e Definir Meta
                    </button>
                </form>

                <div id="tdee-results" class="mt-4 p-3 bg-green-50 rounded-lg hidden">
                    <p class="font-semibold text-sm text-green-800">Seu Gasto Cal√≥rico Estimado:</p>
                    <p id="result-bmr" class="text-xs text-gray-700">BMR (Metabolismo Basal): -</p>
                    <p id="result-tdee" class="text-2xl font-extrabold text-green-700 mt-1">TDEE: 0 kcal/dia</p>
                    <p id="result-message" class="text-xs mt-2 text-green-600 font-medium">A meta foi atualizada.</p>
                </div>
            </div>


            <!-- AJUSTAR META CAL√ìRICA (Manteve-se a √°rea para ajuste manual, caso prefira) -->
            <div class="p-4 bg-card-bg rounded-xl shadow-md mb-6">
                <h3 class="text-xl font-semibold mb-3 text-text-default">Meta Cal√≥rica Atual</h3>
                <p id="current-goal-display" class="mt-3 text-lg font-bold text-primary">Meta Atual: 2000 kcal</p>
                
                <form id="set-goal-form" class="flex gap-2 mt-4">
                    <input type="number" id="calorie-goal-input" placeholder="Ajuste Manual (kcal)" required min="1000"
                           class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    <button type="submit"
                            class="bg-primary text-white p-3 rounded-lg font-semibold shadow-lg hover:bg-opacity-90 transition duration-150">
                        Salvar Manual
                    </button>
                </form>
            </div>

            <!-- Formul√°rio/Bot√£o de Reset -->
            <div class="p-4 bg-card-bg rounded-xl shadow-md">
                <h3 class="text-xl font-semibold mb-3 text-text-default">Gerenciamento de Dados</h3>
                <button id="reset-data-button"
                        class="w-full bg-red-500 text-white p-3 rounded-xl font-semibold shadow-lg hover:bg-red-600 transition duration-150">
                    ‚ö†Ô∏è Resetar Todos os Dados
                </button>
                <p class="mt-2 text-xs text-red-700 text-center">Isso apagar√° permanentemente todos os seus dados salvos no navegador.</p>

                <!-- Modal de Confirma√ß√£o (Simulado) -->
                <div id="reset-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                        <p class="text-lg font-bold mb-4">Confirmar Exclus√£o</p>
                        <p class="mb-6">Tem certeza que deseja apagar todos os dados de treinos e alimenta√ß√£o?</p>
                        <div class="flex justify-end gap-3">
                            <button id="cancel-reset" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancelar</button>
                            <button id="confirm-reset" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Confirmar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>
    
    <!-- NOVO: MODAL GERENCIADOR DE PRATOS (Template Manager) -->
    <div id="template-manager-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div class="bg-card-bg p-4 rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-3 text-strength-color border-b pb-2">Gerenciar Pratos R√°pidos</h3>
            
            <form id="template-editor-form" class="space-y-4">
                
                <!-- 1. Sele√ß√£o/Nome do Template -->
                <div>
                    <label for="template-name-input" class="text-sm font-medium text-gray-700">Nome do Prato:</label>
                    <input type="text" id="template-name-input" placeholder="Novo Prato ou Prato para Editar" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-strength-color">
                </div>
                
                <!-- 2. Adicionar Item ao Prato -->
                <div class="p-3 bg-gray-50 rounded-lg border">
                    <h4 class="text-md font-semibold mb-2">Adicionar Item ao Prato</h4>
                    <!-- REMOVIDO: required do input de busca para evitar valida√ß√£o ao salvar -->
                    <input type="text" id="template-food-name" placeholder="Buscar Alimento" list="food-list-manager"
                           class="w-full p-2 border border-gray-300 rounded-lg text-sm mb-2">
                    <datalist id="food-list-manager">
                        <!-- Itens do datalist de alimentos ser√£o duplicados aqui pelo JS -->
                    </datalist>
                    
                    <div class="flex gap-2">
                        <input type="number" id="template-food-quantity" placeholder="Quantidade" required min="1" value="100"
                               class="w-1/2 p-2 border border-gray-300 rounded-lg text-sm">
                        <input type="text" id="template-food-unit-display" placeholder="Unidade" disabled
                               class="w-1/2 p-2 border border-gray-300 rounded-lg text-sm bg-gray-200">
                    </div>
                    <button id="add-item-to-template" type="button"
                            class="w-full mt-3 bg-blue-500 text-white p-2 rounded-lg font-semibold hover:bg-blue-600 transition duration-150 text-sm">
                        + Adicionar Item
                    </button>
                </div>
                
                <!-- 3. Composi√ß√£o Atual do Prato (Staging List) -->
                <div>
                    <h4 class="text-md font-semibold mb-2 flex justify-between">
                        Composi√ß√£o Atual:
                        <span id="template-total-items" class="text-sm text-gray-500 font-normal">0 itens</span>
                    </h4>
                    <!-- DELEGA√á√ÉO DE EVENTOS OCORRER√Å NESTE CONTAINER -->
                    <div id="template-composition-list" class="space-y-2 max-h-40 overflow-y-auto border p-2 rounded-lg bg-white">
                        <p class="text-gray-500 text-sm text-center">Nenhum item adicionado.</p>
                    </div>
                </div>

                <!-- 4. A√ß√µes (Salvar/Deletar) -->
                <div class="grid grid-cols-2 gap-3 pt-3 border-t">
                    <button id="delete-template-btn" type="button"
                            class="bg-red-500 text-white p-3 rounded-xl font-semibold shadow-lg hover:bg-red-600 transition duration-150">
                        Deletar Prato
                    </button>
                    <button type="submit"
                            class="bg-primary text-white p-3 rounded-xl font-semibold shadow-lg hover:bg-primary-dark transition duration-150">
                        Salvar Prato
                    </button>
                </div>
                
            </form>

            <button id="close-template-manager" type="button"
                    class="w-full mt-4 p-2 text-gray-600 border border-gray-300 rounded-xl hover:bg-gray-100 transition duration-150 text-sm">
                Fechar
            </button>
            <p id="template-manager-message" class="text-sm mt-3 text-center"></p>
        </div>
    </div>


    <!-- Barra de Navega√ß√£o Inferior (Fixo) -->
    <footer id="nav-bar" class="bg-white border-t border-gray-200 fixed bottom-0 left-0 right-0 max-w-md mx-auto shadow-2xl">
        <nav class="flex justify-around p-3">
            <button class="nav-icon flex flex-col items-center text-gray-400 active" data-tab="workouts">
                <!-- Icone de Halteres (Treinos) -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.828 14.828a4 4 0 01-5.656 0M9 20V4l6 8-6 8zM19 12h-2m-3 0H5"/>
                </svg>
                <span class="text-xs mt-1">Treinos</span>
            </button>
            <button class="nav-icon flex flex-col items-center text-gray-400" data-tab="food">
                <!-- Icone de Ma√ß√£ (Alimenta√ß√£o) -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10zM12 18a4 4 0 100-8 4 4 0 000 8z"/>
                </svg>
                <span class="text-xs mt-1">Alimenta√ß√£o</span>
            </button>
            <button class="nav-icon flex flex-col items-center text-gray-400" data-tab="progress">
                <!-- Icone de Gr√°fico (Progresso) -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                </svg>
                <span class="text-xs mt-1">Progresso</span>
            </button>
            <button class="nav-icon flex flex-col items-center text-gray-400" data-tab="settings">
                <!-- Icone de Configura√ß√µes -->
                <svg xmlns="http://www.w3.org/2300/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.562.344 1.067.653 1.067.653z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span class="text-xs mt-1">Config.</span>
            </button>
        </nav>
    </footer>
</div>

<script>
    // --- CHAVES DE ARMAZENAMENTO ---
    const STORAGE_KEY = 'fitnessTrackerData';
    // Nova chave para alimentos personalizados
    const USER_FOODS_KEY = 'userCustomFoods';

    let appData = {
        calorieGoal: 2000,
        // NOVAS METAS DE MACROS
        proteinGoal: 150, 
        carbsGoal: 200,   
        fatsGoal: 60,     
        currentDate: new Date().toISOString().split('T')[0], // YYYY-MM-DD
        dailyLogs: {}, 
        weightHistory: [], 
        prHistory: {}, // { 'Nome do Exerc√≠cio': [{ date: 'YYYY-MM-DD', load: 100, reps: 5 }] }
        // NOVOS TEMPLATES DE REFEI√á√ÉO (Hardcoded para demonstra√ß√£o)
        mealTemplates: {
            'P√≥s-Treino Padr√£o': [
                { name: 'Frango, Peito, Cozido, Sem Pele', quantity: 150, unit: 'g' },
                { name: 'Arroz, Tipo 1, Cozido', quantity: 150, unit: 'g' },
                { name: 'Br√≥colis, Cozido', quantity: 100, unit: 'g' }
            ],
            'Shake R√°pido': [
                { name: 'Leite, Desnatado, UHT', quantity: 250, unit: 'mL' },
                { name: 'Banana, Prata, Crua', quantity: 100, unit: 'g' }
            ]
        },
        // Estado tempor√°rio para montagem de template no modal
        templateEditorStaging: [],
        calcInputs: {}
    };

    // Vari√°veis de Gr√°fico
    let weightChartInstance = null;
    let calorieChartInstance = null;
    let strengthChartInstance = null; // Inst√¢ncia do novo gr√°fico de for√ßa
    
    // VARI√ÅVEL QUE VAI JUNTAR OS ALIMENTOS FIXOS E OS DO USU√ÅRIO
    let FULL_FOOD_DATABASE = {};

    // --- BANCO DE DADOS DE ALIMENTOS FIXOS ---
    const BASE_FOOD_DATABASE = {
        // --- CEREAIS E DERIVADOS (Valores por 100g) ---
        'Arroz, Integral, Cozido': { calories: 124, protein: 2.6, carbs: 25.8, fats: 1.0, unit: 'g', portion: 100, category: 'Cereais e Derivados' },
        'Arroz, Tipo 1, Cozido': { calories: 128, protein: 2.5, carbs: 28.1, fats: 0.2, unit: 'g', portion: 100, category: 'Cereais e Derivados' },
        'Aveia, Flocos, Crua': { calories: 394, protein: 13.9, carbs: 66.6, fats: 8.5, unit: 'g', portion: 100, category: 'Cereais e Derivados' }, 
        'Biscoito, Doce, Maisena': { calories: 443, protein: 8.1, carbs: 75.2, fats: 12.0, unit: 'g', portion: 100, category: 'Cereais e Derivados' },
        'Canjica, com Leite Integral': { calories: 112, protein: 2.4, carbs: 23.6, fats: 1.2, unit: 'g', portion: 100, category: 'Cereais e Derivados' },
        'Cereal Matinal, Milho (A√ß√∫car)': { calories: 377, protein: 4.7, carbs: 88.8, fats: 0.7, unit: 'g', portion: 100, category: 'Cereais e Derivados' },
        'Macarr√£o, Lasanha, Cozida': { calories: 164, protein: 5.8, carbs: 32.5, fats: 1.2, unit: 'g', portion: 100, category: 'Cereais e Derivados' },
        'Pamonha, Pr√©-cozida': { calories: 171, protein: 2.6, carbs: 30.7, fats: 4.8, unit: 'g', portion: 100, category: 'Cereais e Derivados' },
        'P√£o, Trigo, Integral': { calories: 253, protein: 9.4, carbs: 49.9, fats: 3.7, unit: 'g', portion: 100, category: 'Cereais e Derivados' },
        'P√£o, Trigo, Franc√™s': { calories: 300, protein: 8.0, carbs: 58.6, fats: 3.1, unit: 'g', portion: 100, category: 'Cereais e Derivados' },
        'Pastel, de Carne, Frito': { calories: 388, protein: 10.1, carbs: 43.8, fats: 20.1, unit: 'g', portion: 100, category: 'Cereais e Derivados' },
        'Pipoca, com √ìleo de Soja': { calories: 448, protein: 9.9, carbs: 70.3, fats: 15.9, unit: 'g', portion: 100, category: 'Cereais e Derivados' },
        
        // --- HORTALI√áAS E DERIVADOS (Valores por 100g) ---
        'Ab√≥bora, Cabotian, Cozida': { calories: 48, protein: 1.4, carbs: 10.8, fats: 0.7, unit: 'g', portion: 100, category: 'Hortali√ßas e Derivados' },
        'Ab√≥bora, Moranga, Refogada': { calories: 29, protein: 0.4, carbs: 6.0, fats: 0.8, unit: 'g', portion: 100, category: 'Hortali√ßas e Derivados' },
        'Abobrinha, Italiana, Cozida': { calories: 15, protein: 1.1, carbs: 3.0, fats: 0.2, unit: 'g', portion: 100, category: 'Hortali√ßas e Derivados' },
        'Alho, Cru': { calories: 113, protein: 7.0, carbs: 23.9, fats: 0.2, unit: 'g', portion: 100, category: 'Hortali√ßas e Derivados' }, // Usado como tempero
        'Almeir√£o, Refogado': { calories: 65, protein: 1.7, carbs: 5.7, fats: 4.8, unit: 'g', portion: 100, category: 'Hortali√ßas e Derivados' },
        'Batata, Doce, Cozida': { calories: 77, protein: 0.6, carbs: 18.4, fats: 0.1, unit: 'g', portion: 100, category: 'Hortali√ßas e Derivados' },
        'Batata, Inglesa, Cozida': { calories: 52, protein: 1.2, carbs: 11.9, fats: 0.0, unit: 'g', portion: 100, category: 'Hortali√ßas e Derivados' },
        'Batata, Frita (Chips Ind.)': { calories: 543, protein: 5.6, carbs: 51.2, fats: 36.6, unit: 'g', portion: 100, category: 'Hortali√ßas e Derivados' },
        'Br√≥colis, Cozido': { calories: 25, protein: 2.1, carbs: 4.4, fats: 0.5, unit: 'g', portion: 100, category: 'Hortali√ßas e Derivados' },
        'Cenoura, Cozida': { calories: 30, protein: 0.8, carbs: 6.7, fats: 0.2, unit: 'g', portion: 100, category: 'Hortali√ßas e Derivados' },
        'Chuchu, Cozido': { calories: 19, protein: 0.4, carbs: 4.8, fats: 0.0, unit: 'g', portion: 100, category: 'Hortali√ßas e Derivados' },
        'Couve, Manteiga, Refogada': { calories: 90, protein: 1.7, carbs: 8.7, fats: 6.6, unit: 'g', portion: 100, category: 'Hortali√ßas e Derivados' },
        'Tomate, Molho Industrializado': { calories: 38, protein: 1.4, carbs: 7.7, fats: 0.9, unit: 'g', portion: 100, category: 'Hortali√ßas e Derivados' },
        
        // --- FRUTAS E DERIVADOS (Valores por 100g) ---
        'Abacate, Cru': { calories: 96, protein: 1.2, carbs: 6.0, fats: 8.4, unit: 'g', portion: 100, category: 'Frutas e Derivados' }, // Geralmente consumido cru
        'Abacaxi, Cru': { calories: 48, protein: 0.9, carbs: 12.3, fats: 0.1, unit: 'g', portion: 100, category: 'Frutas e Derivados' },
        'Acerola, Polpa Congelada': { calories: 22, protein: 0.6, carbs: 5.5, fats: 0.0, unit: 'g', portion: 100, category: 'Frutas e Derivados' },
        'Banana, Prata, Crua': { calories: 98, protein: 1.3, carbs: 26.0, fats: 0.1, unit: 'g', portion: 100, category: 'Frutas e Derivados' },
        'Goiaba, Doce em Pasta': { calories: 269, protein: 0.6, carbs: 74.1, fats: 0.0, unit: 'g', portion: 100, category: 'Frutas e Derivados' },
        'Laranja, P√™ra, Suco': { calories: 33, protein: 0.7, carbs: 7.6, fats: 0.1, unit: 'mL', portion: 100, category: 'Frutas e Derivados' },
        'Mam√£o, Formosa, Cru': { calories: 45, protein: 0.8, carbs: 11.6, fats: 0.1, unit: 'g', portion: 100, category: 'Frutas e Derivados' },
        'Manga, Palmer, Crua': { calories: 72, protein: 0.4, carbs: 19.4, fats: 0.2, unit: 'g', portion: 100, category: 'Frutas e Derivados' },
        'Morango, Cru': { calories: 30, protein: 0.9, carbs: 6.8, fats: 0.3, unit: 'g', portion: 100, category: 'Frutas e Derivados' },
        'Pupunha, Cozida': { calories: 219, protein: 2.5, carbs: 29.6, fats: 12.8, unit: 'g', portion: 100, category: 'Frutas e Derivados' },

        // --- GORDURAS E √ìLEOS (Valores por 100g) ---
        'Azeite, de Oliva, Extra Virgem': { calories: 884, protein: 0.0, carbs: 0.0, fats: 100.0, unit: 'g', portion: 10, category: 'Gorduras e √ìleos' }, // Por√ß√£o 10g (1 colher de sopa)
        '√ìleo, de Soja': { calories: 884, protein: 0.0, carbs: 0.0, fats: 100.0, unit: 'g', portion: 10, category: 'Gorduras e √ìleos' },
        'Manteiga, com Sal': { calories: 726, protein: 0.4, carbs: 0.1, fats: 82.4, unit: 'g', portion: 10, category: 'Gorduras e √ìleos' },
        'Margarina (65% Lip.)': { calories: 596, protein: 0.0, carbs: 0.0, fats: 67.4, unit: 'g', portion: 10, category: 'Gorduras e √ìleos' },
        
        // --- PESCADOS E FRUTOS DO MAR (Valores por 100g) ---
        'Salm√£o, Grelhado, Sem Pele': { calories: 243, protein: 26.1, carbs: 0.0, fats: 14.5, unit: 'g', portion: 100, category: 'Pescados e Frutos do Mar' },
        'Atum, Conserva em √ìleo (Drenado)': { calories: 166, protein: 26.2, carbs: 0.0, fats: 6.0, unit: 'g', portion: 100, category: 'Pescados e Frutos do Mar' },
        'Merluza, Fil√©, Frito': { calories: 192, protein: 26.9, carbs: 0.0, fats: 8.5, unit: 'g', portion: 100, category: 'Pescados e Frutos do Mar' },
        'Camar√£o, Cozido (Grande)': { calories: 90, protein: 19.0, carbs: 0.0, fats: 1.0, unit: 'g', portion: 100, category: 'Pescados e Frutos do Mar' },
        'Sardinha, Assada': { calories: 164, protein: 32.2, carbs: 0.0, fats: 3.0, unit: 'g', portion: 100, category: 'Pescados e Frutos do Mar' },

        // --- CARNES E DERIVADOS (Valores por 100g) ---
        'Carne Bovina, Patinho, Grelhado': { calories: 219, protein: 35.9, carbs: 0.0, fats: 7.3, unit: 'g', portion: 100, category: 'Carnes e Derivados' },
        'Carne Bovina, Fil√© Mignon, Grelhado': { calories: 220, protein: 32.8, carbs: 0.0, fats: 8.8, unit: 'g', portion: 100, category: 'Carnes e Derivados' },
        'Frango, Peito, Cozido, Sem Pele': { calories: 163, protein: 31.5, carbs: 0.0, fats: 3.2, unit: 'g', portion: 100, category: 'Carnes e Derivados' },
        'Frango, Coxa, Cozida, Sem Pele': { calories: 167, protein: 26.9, carbs: 0.0, fats: 5.8, unit: 'g', portion: 100, category: 'Carnes e Derivados' },
        'Porco, Lombo, Assado': { calories: 210, protein: 35.7, carbs: 0.0, fats: 6.4, unit: 'g', portion: 100, category: 'Carnes e Derivados' },
        'Presunto, Sem Gordura': { calories: 94, protein: 14.3, carbs: 2.1, fats: 2.7, unit: 'g', portion: 100, category: 'Carnes e Derivados' },
        'Hamb√∫rguer, Frito': { calories: 258, protein: 20.0, carbs: 6.3, fats: 17.0, unit: 'g', portion: 100, category: 'Carnes e Derivados' },
        
        // --- LEITE E DERIVADOS (Valores por 100g) ---
        'Leite, Integral, UHT': { calories: 61, protein: 3.0, carbs: 4.7, fats: 3.2, unit: 'mL', portion: 100, category: 'Leite e Derivados' },
        'Leite, Desnatado, UHT': { calories: 37, protein: 3.4, carbs: 4.9, fats: 0.1, unit: 'mL', portion: 100, category: 'Leite e Derivados' },
        'Iogurte, Natural, Desnatado': { calories: 41, protein: 3.8, carbs: 5.8, fats: 0.3, unit: 'g', portion: 100, category: 'Leite e Derivados' },
        'Queijo, Minas Frescal': { calories: 264, protein: 17.4, carbs: 3.2, fats: 20.2, unit: 'g', portion: 100, category: 'Leite e Derivados' },
        'Queijo, Mussarela': { calories: 330, protein: 22.6, carbs: 3.0, fats: 25.2, unit: 'g', portion: 100, category: 'Leite e Derivados' },
        'Requeij√£o, Cremoso': { calories: 257, protein: 9.6, carbs: 2.4, fats: 23.4, unit: 'g', portion: 100, category: 'Leite e Derivados' },
        'Leite, Condensado': { calories: 313, protein: 7.7, carbs: 57.0, fats: 6.7, unit: 'g', portion: 100, category: 'Leite e Derivados' },

        // --- OVOS E DERIVADOS ---
        'Ovo de Galinha, Cozido': { calories: 146, protein: 13.3, carbs: 0.6, fats: 9.5, unit: 'unidade', portion: 50, category: 'Ovos e Derivados' },
        'Omelete, de Queijo': { calories: 268, protein: 15.6, carbs: 0.4, fats: 22.0, unit: 'g', portion: 100, category: 'Ovos e Derivados' },

        // --- LEGUMINOSAS E DERIVADOS (Valores por 100g) ---
        'Feij√£o, Carioca, Cozido': { calories: 76, protein: 4.8, carbs: 13.6, fats: 0.5, unit: 'g', portion: 100, category: 'Leguminosas e Derivados' },
        'Feij√£o, Preto, Cozido': { calories: 77, protein: 4.5, carbs: 14.0, fats: 0.5, unit: 'g', portion: 100, category: 'Leguminosas e Derivados' },
        'Lentilha, Cozida': { calories: 93, protein: 6.3, carbs: 16.3, fats: 0.5, unit: 'g', portion: 100, category: 'Leguminosas e Derivados' },
        'Ervilha, Enlatada (Drenada)': { calories: 74, protein: 4.6, carbs: 13.4, fats: 0.4, unit: 'g', portion: 100, category: 'Leguminosas e Derivados' },
        'Tofu (Queijo de Soja)': { calories: 64, protein: 6.6, carbs: 2.1, fats: 4.0, unit: 'g', portion: 100, category: 'Leguminosas e Derivados' },

        // --- NOZES E SEMENTES (Valores por 100g) ---
        'Amendoim, Torrado Salgado': { calories: 606, protein: 22.5, carbs: 18.7, fats: 54.0, unit: 'g', portion: 100, category: 'Nozes e Sementes' },
        'Castanha-de-Caju, Torrada': { calories: 570, protein: 18.5, carbs: 29.1, fats: 46.3, unit: 'g', portion: 100, category: 'Nozes e Sementes' },
        'Coco, Cru': { calories: 406, protein: 3.7, carbs: 10.4, fats: 42.0, unit: 'g', portion: 100, category: 'Nozes e Sementes' }, // Comest√≠vel cru
        'Pinh√£o, Cozido': { calories: 174, protein: 3.0, carbs: 43.9, fats: 0.7, unit: 'g', portion: 100, category: 'Nozes e Sementes' },
        
        // --- PRODUTOS A√áUCARADOS ---
        'A√ß√∫car, Refinado': { calories: 387, protein: 0.3, carbs: 99.5, fats: 0.0, unit: 'g', portion: 10, category: 'Produtos A√ßucarados' },
        'Mel, de Abelha': { calories: 309, protein: 0.0, carbs: 84.0, fats: 0.0, unit: 'g', portion: 10, category: 'Produtos A√ßucarados' },
        'Chocolate, Meio Amargo': { calories: 475, protein: 4.9, carbs: 62.4, fats: 29.9, unit: 'g', portion: 100, category: 'Produtos A√ßucarados' },
        'Doce, de Leite, Cremoso': { calories: 306, protein: 5.5, carbs: 59.5, fats: 6.0, unit: 'g', portion: 100, category: 'Produtos A√ßucarados' },

        // --- ALIMENTOS PREPARADOS/MISTOS ---
        'Arroz Carreteiro': { calories: 154, protein: 10.8, carbs: 11.6, fats: 7.1, unit: 'g', portion: 100, category: 'Alimentos Preparados/Mistos' },
        'Feijoada': { calories: 117, protein: 8.7, carbs: 11.6, fats: 6.5, unit: 'g', portion: 100, category: 'Alimentos Preparados/Mistos' },
        'Salpic√£o de Frango': { calories: 148, protein: 13.9, carbs: 4.6, fats: 7.8, unit: 'g', portion: 100, category: 'Alimentos Preparados/Mistos' },
        'Macarr√£o, Molho Bolognesa': { calories: 120, protein: 4.9, carbs: 22.5, fats: 0.9, unit: 'g', portion: 100, category: 'Alimentos Preparados/Mistos' },
        'Vatap√°': { calories: 255, protein: 6.0, carbs: 9.7, fats: 23.2, unit: 'g', portion: 100, category: 'Alimentos Preparados/Mistos' },
    };
    
    // --- BASE DE DADOS DE EXERC√çCIOS EXPANDIDA E ATUALIZADA ---
    const EXERCISE_DATABASE = {
        'Peito': [
            'Supino Reto com Barra', 'Supino Inclinado com Halteres', 'Crossover Alto', 
            'Flex√£o de Bra√ßo', 'Supino Declinado', 'Crucifixo com Halteres', 'Pec Deck',
            'Supino Reto Halteres', 'Flex√£o Diamante', 
            'Supino M√°quina', 
            'Crucifixo M√°quina'
        ],
        'Costas': [
            'Remada Curvada com Barra', 'Puxada Frontal (Pulley)', 'Levantamento Terra', 
            'Remada Cavalinho', 'Serrote (Remada Unilateral)', 'Pull Down', 'Hiperextens√£o Lombar',
            'Remada Sentada (Cabo)', 'Barra Fixa (Assistida/Livre)',
            'Puxada Alta', 
            'Puxada Baixa'
        ],
        'Pernas': [
            'Agachamento Livre', 'Leg Press 45¬∫', 'Cadeira Extensora', 'Mesa Flexora', 
            'Panturrilha no Smith', 'Agachamento B√∫lgaro', 'Stiff', 'Cadeira Adutora/Abdutora',
            'Hack Machine', 'Afundo com Halteres',
            'Cadeira Flexora', 
            'Cadeira Extensora', 
            'Cadeira Abdutora', 
            'Cadeira Adutora', 
            'Panturrilha Cavalinho'
        ],
        'Ombros': [
            'Desenvolvimento Militar em p√©', 'Eleva√ß√£o Lateral', 'Eleva√ß√£o Frontal', 
            'Remada Alta', 'Face Pull', 'Desenvolvimento Arnold', 'Crucifixo Inverso',
            'Desenvolvimento com Halteres', 'Remada Alta (Cabo)',
            'Desenvolvimento M√°quina', 
            'Encolhimento'
        ],
        'Bra√ßos (B√≠ceps/Tr√≠ceps)': [
            'Rosca Direta com Barra', 'Tr√≠ceps Corda', 'Rosca Martelo', 'Tr√≠ceps Testa', 
            'Rosca Concentrada', 'Paralelas (Tr√≠ceps)', 'Rosca Scott', 'Tr√≠ceps Supinado',
            'Rosca Alternada', 'Extens√£o de Tr√≠ceps por cima da cabe√ßa',
            'Tr√≠ceps Barra', 
            'Tr√≠ceps Barra W', 
            'Rosca Alternada 45¬∞'
        ],
        'Abd√¥men/Core': [
            'Abdominal no Solo', 'Prancha (30s)', 'Eleva√ß√£o de Pernas', 'Rota√ß√£o Russa', 
            'Abdominal Infra na Paralela', 'Abdominal na M√°quina', 'Prancha Lateral (30s)',
            'Crunch no Cabo'
        ],
        'Antebra√ßo': [ 
            'Rosca Punho com Barra', 
            'Rosca Punho na Polia', 
            'Rosca Punho Invertida na Polia'
        ],
        'Cardio': [
            'Corrida 30min (Est. 250 Kcal)', 'Bicicleta 30min (Est. 250 Kcal)', 
            'El√≠ptico 30min (Est. 250 Kcal)', 'HIIT 20min (Est. 300 Kcal)', 
            'Nata√ß√£o 30min (Est. 350 Kcal)', 'Pular Corda 15min (Est. 150 Kcal)'
        ]
    };

    // --- FUN√á√ïES DE PERSIST√äNCIA E INICIALIZA√á√ÉO ---

    function loadData() {
        // ... (Corpo da fun√ß√£o loadData)
        try {
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (storedData) {
                const parsedData = JSON.parse(storedData);
                
                // Mescla os dados salvos com a estrutura padr√£o para evitar erros
                appData = { ...appData, ...parsedData };
                
                // Corre√ß√£o de migra√ß√£o: garante que prHistory e mealTemplates sejam objetos
                if (typeof appData.prHistory === 'undefined' || appData.prHistory === null) {
                    appData.prHistory = {};
                }
                // Garante que mealTemplates exista (se o usu√°rio n√£o o tiver exclu√≠do no reset manual, etc.)
                if (typeof appData.mealTemplates === 'undefined' || appData.mealTemplates === null) {
                    // Preserva os templates hardcoded se n√£o houver nada salvo
                    appData.mealTemplates = {
                        'P√≥s-Treino Padr√£o': [
                            { name: 'Frango, Peito, Cozido, Sem Pele', quantity: 150, unit: 'g' },
                            { name: 'Arroz, Tipo 1, Cozido', quantity: 150, unit: 'g' },
                            { name: 'Br√≥colis, Cozido', quantity: 100, unit: 'g' }
                        ],
                        'Shake R√°pido': [
                            { name: 'Leite, Desnatado, UHT', quantity: 250, unit: 'mL' },
                            { name: 'Banana, Prata, Crua', quantity: 100, unit: 'g' }
                        ]
                    };
                }
                
                // Garante que as novas metas de macro existam (para retrocompatibilidade)
                if (typeof appData.proteinGoal === 'undefined') appData.proteinGoal = 150;
                if (typeof appData.carbsGoal === 'undefined') appData.carbsGoal = 200;
                if (typeof appData.fatsGoal === 'undefined') appData.fatsGoal = 60;
            }
            
            // Inicializa a base de dados mesclada (fixa + usu√°rio)
            mergeFoodDatabases();

            // Seta a data atual no seletor de data da aba Alimenta√ß√£o, Treinos e Peso
            const today = new Date().toISOString().split('T')[0];
            appData.currentDate = today;
            
            // Verifica a exist√™ncia dos elementos antes de tentar atribuir
            if (document.getElementById('food-date-select')) document.getElementById('food-date-select').value = today;
            if (document.getElementById('workout-date-select')) document.getElementById('workout-date-select').value = today;
            if (document.getElementById('weight-date-select')) document.getElementById('weight-date-select').value = today;
        } catch (error) {
            console.error("Erro ao carregar dados do LocalStorage:", error);
        }
    }

    function saveData() {
        // ... (Corpo da fun√ß√£o saveData)
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        } catch (error) {
            console.error("Erro ao salvar dados no LocalStorage:", error);
        }
    }

    function mergeFoodDatabases() {
        // ... (Corpo da fun√ß√£o mergeFoodDatabases)
        let userFoods = {};
        try {
            const storedFoods = localStorage.getItem(USER_FOODS_KEY);
            if (storedFoods) {
                userFoods = JSON.parse(storedFoods);
            }
        } catch (error) {
            console.error("Erro ao carregar alimentos do usu√°rio:", error);
        }

        // Mescla (alimentos do usu√°rio sobrescrevem os fixos se tiverem o mesmo nome)
        FULL_FOOD_DATABASE = { ...BASE_FOOD_DATABASE, ...userFoods };
    }
    
    // --- FUN√á√ÉO DE FEEDBACK (SUBSTITUINDO ALERT/CONFIRM) ---
    function showMessage(elementId, message, colorClass) {
        const el = document.getElementById(elementId);
        if (el) {
            el.className = `text-sm mt-2 text-center ${colorClass}`;
            el.textContent = message;
            setTimeout(() => {
                el.textContent = '';
                el.className = `text-sm mt-2 text-center form-message-placeholder`;
            }, 4000);
        }
    }

    // --- FUN√á√ïES DE C√ÅLCULO E RENDERIZA√á√ÉO ---

    function calculateVolume(load, reps) {
        return load * reps;
    }
    
    function getLastExerciseEntry(exerciseName) {
        const dates = Object.keys(appData.dailyLogs).sort().reverse();
        for (const date of dates) {
            const log = appData.dailyLogs[date];
            if (log && log.workouts) {
                for (let i = log.workouts.length - 1; i >= 0; i--) {
                    const ex = log.workouts[i];
                    if (ex.name === exerciseName) {
                        return ex;
                    }
                }
            }
        }
        return null;
    }

    function updatePR(exerciseName, date, load, reps) {
        if (load <= 0) return;

        const currentVolume = calculateVolume(load, reps);
        
        if (!appData.prHistory[exerciseName]) {
            appData.prHistory[exerciseName] = [];
        }

        const history = appData.prHistory[exerciseName];
        
        const bestPR = history.reduce((best, entry) => {
            const entryVolume = calculateVolume(entry.load, entry.reps);
            if (entryVolume > calculateVolume(best.load, best.reps)) {
                return entry;
            }
            return best;
        }, { load: 0, reps: 0, volume: 0 });
        
        if (currentVolume > calculateVolume(bestPR.load, bestPR.reps)) {
            history.push({
                date: date,
                load: load,
                reps: reps,
                volume: currentVolume
            });
            console.log(`PARAB√âNS! Novo Recorde Pessoal (PR) em ${exerciseName}: ${load} kg x ${reps} reps!`);
            history.sort((a, b) => new Date(a.date) - new Date(b.date));
        }
    }

    function formatDisplayDate(isoDate) {
        const date = new Date(isoDate + 'T00:00:00');
        const options = { weekday: 'short', day: '2-digit', month: 'short' };
        return date.toLocaleDateString('pt-BR', options).replace('.', '');
    }

    function getCurrentDayLog(date = appData.currentDate) {
        if (!appData.dailyLogs[date]) {
            appData.dailyLogs[date] = { workouts: [], meals: [], isWorkoutDone: false, workoutCalories: 0 };
        }
        if (typeof appData.dailyLogs[date].workoutCalories === 'undefined') {
            appData.dailyLogs[date].workoutCalories = 0;
        }
        return appData.dailyLogs[date];
    }

    function calculateBMR(gender, weight, height, age) {
        if (gender === 'male') {
            return Math.round((10 * weight) + (6.25 * height) - (5 * age) + 5);
        } else if (gender === 'female') {
            return Math.round((10 * weight) + (6.25 * height) - (5 * age) - 161);
        }
        return 0;
    }

    function calculateTDEE(bmr, activityMultiplier) {
        return Math.round(bmr * activityMultiplier);
    }

    function estimateStrengthWorkoutCalories(sets, reps, load) {
        const baseBurn = 15;
        const loadFactor = 0.02; 
        return Math.round(baseBurn + (sets * reps * load * loadFactor));
    }

    function calculateTotalWorkoutCalories() {
        const dayLog = getCurrentDayLog();
        let totalCalories = 0;

        dayLog.workouts.forEach(ex => {
            if (ex.category === 'Cardio') {
                const match = ex.name.match(/\(([\d]+)\sKcal\)/);
                totalCalories += match ? parseInt(match[1]) : 250; 
            } else {
                totalCalories += estimateStrengthWorkoutCalories(ex.sets, ex.reps, ex.load);
            }
        });

        dayLog.workoutCalories = totalCalories;
        return totalCalories;
    }

    function calculateDailyTotals() {
        const dayLog = getCurrentDayLog();
        return dayLog.meals.reduce((totals, meal) => {
            totals.calories += parseFloat(meal.calories) || 0;
            totals.protein += parseFloat(meal.protein) || 0;
            totals.carbs += parseFloat(meal.carbs) || 0;
            totals.fats += parseFloat(meal.fats) || 0;
            return totals;
        }, { calories: 0, protein: 0, carbs: 0, fats: 0 });
    }

    function renderDailySummary() {
        // ... (Corpo da fun√ß√£o renderDailySummary)
        const { calories, protein, carbs, fats } = calculateDailyTotals();
        const workoutBurn = calculateTotalWorkoutCalories();
        const remainingCal = appData.calorieGoal - calories;
        const isWorkoutDone = getCurrentDayLog().isWorkoutDone;
        
        const remainingProtein = appData.proteinGoal - protein;
        const remainingCarbs = appData.carbsGoal - carbs;
        const remainingFats = appData.fatsGoal - fats;

        document.getElementById('daily-date').textContent = formatDisplayDate(appData.currentDate);
        
        document.getElementById('summary-grid').innerHTML = `
            <!-- Linha 1: Calorias -->
            <div>
                <p class="text-gray-500">Calorias Consumidas:</p>
                <p id="summary-consumed" class="font-bold text-xl text-primary">${calories} kcal</p>
            </div>
            <div>
                <p class="text-gray-500">Meta Restante:</p>
                <p id="summary-remaining" class="font-bold text-xl ${remainingCal >= 0 ? 'text-blue-500' : 'text-red-500'}">${remainingCal >= 0 ? remainingCal : `+${Math.abs(remainingCal)}`} kcal</p>
            </div>

            <!-- Linha 2: Macros Restantes -->
            <div class="col-span-2 mt-2 pt-2 border-t border-gray-200">
                <p class="font-semibold text-text-default mb-1">Macros Restantes (g):</p>
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div class="p-1 bg-gray-50 rounded-lg border border-gray-200">
                        <p class="text-xs text-gray-500">Ptn (${appData.proteinGoal}g)</p>
                        <p class="font-bold ${remainingProtein >= 0 ? 'text-blue-600' : 'text-red-500'}">${remainingProtein >= 0 ? remainingProtein : `+${Math.abs(remainingProtein).toFixed(0)}`}g</p>
                    </div>
                    <div class="p-1 bg-gray-50 rounded-lg border border-gray-200">
                        <p class="text-xs text-gray-500">Crbs (${appData.carbsGoal}g)</p>
                        <p class="font-bold ${remainingCarbs >= 0 ? 'text-blue-600' : 'text-red-500'}">${remainingCarbs >= 0 ? remainingCarbs : `+${Math.abs(remainingCarbs).toFixed(0)}`}g</p>
                    </div>
                    <div class="p-1 bg-gray-50 rounded-lg border border-gray-200">
                        <p class="text-xs text-gray-500">Gord (${appData.fatsGoal}g)</p>
                        <p class="font-bold ${remainingFats >= 0 ? 'text-blue-600' : 'text-red-500'}">${remainingFats >= 0 ? remainingFats : `+${Math.abs(remainingFats).toFixed(0)}`}g</p>
                    </div>
                </div>
            </div>
            
            <!-- Linha 3: Status Treino e Queima -->
            <div class="col-span-2 mt-2 pt-2 border-t border-gray-200 grid grid-cols-2 gap-3">
                <div>
                    <p class="text-gray-500">Treino Status:</p>
                    <p id="summary-workout-status" class="font-bold text-lg ${isWorkoutDone ? 'text-primary' : 'text-red-500'}">${isWorkoutDone ? '‚úÖ Conclu√≠do' : '‚ùå N√£o Registrado'}</p>
                </div>
                <div>
                    <p class="text-gray-500">Calorias Queimadas (Est.):</p>
                    <p id="summary-workout-calories" class="font-bold text-lg text-purple-600">${workoutBurn} kcal</p>
                </div>
            </div>
        `;
    }

    function renderWorkouts() {
        // ... (Corpo da fun√ß√£o renderWorkouts)
        const date = document.getElementById('workout-date-select').value;
        const log = appData.dailyLogs[date] || { workouts: [] };
        const workoutsLogEl = document.getElementById('workouts-log');
        workoutsLogEl.innerHTML = '';

        if (log.workouts.length === 0) {
            workoutsLogEl.innerHTML = '<p class="text-center text-gray-500 p-4 bg-gray-100 rounded-xl">Nenhum treino registrado para esta data.</p>';
        } else {
            log.workouts.forEach((ex, index) => {
                let estimatedBurn;
                if (ex.category === 'Cardio') {
                    const match = ex.name.match(/\(([\d]+)\sKcal\)/);
                    estimatedBurn = match ? parseInt(match[1]) : 250;
                } else {
                    estimatedBurn = estimateStrengthWorkoutCalories(ex.sets, ex.reps, ex.load);
                }
                
                const item = document.createElement('div');
                item.className = 'p-4 bg-card-bg rounded-xl shadow-sm border-l-4 border-primary-light flex justify-between items-center';
                item.innerHTML = `
                    <div>
                        <p class="font-bold text-text-default">${ex.name} <span class="text-xs font-normal text-purple-600">(${ex.category})</span></p>
                        <p class="text-sm text-gray-600">S√©ries: ${ex.sets} | Reps: ${ex.reps} | Carga: ${ex.load} kg</p>
                        <p class="text-xs text-purple-500 font-semibold mt-1">Estimativa de Queima: ${estimatedBurn} kcal</p>
                    </div>
                    <button data-index="${index}" data-type="workout" data-date="${date}" class="delete-item-btn text-red-400 hover:text-red-600 p-2 rounded-full transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                `;
                workoutsLogEl.appendChild(item);
            });
        }
        
        if (date === appData.currentDate) {
            renderDailySummary();
        }
    }

    function renderFood() {
        // ... (Corpo da fun√ß√£o renderFood)
        const date = document.getElementById('food-date-select').value;
        const log = appData.dailyLogs[date] || { meals: [] };
        const foodLogEl = document.getElementById('food-log');
        foodLogEl.innerHTML = '';

        if (log.meals.length === 0) {
            foodLogEl.innerHTML = '<p class="text-center text-gray-500 p-4 bg-gray-100 rounded-xl">Nenhuma refei√ß√£o registrada para esta data.</p>';
        } else {
            const groupedMeals = log.meals.reduce((acc, meal) => {
                const type = meal.type || 'Lanche/Outros';
                if (!acc[type]) {
                    acc[type] = [];
                }
                acc[type].push(meal);
                return acc;
            }, {});

            for (const type in groupedMeals) {
                const mealsOfType = groupedMeals[type];
                
                const mealTotals = mealsOfType.reduce((acc, meal) => {
                    acc.calories += meal.calories;
                    acc.protein += meal.protein;
                    acc.carbs += meal.carbs;
                    acc.fats += meal.fats;
                    return acc;
                }, { calories: 0, protein: 0, carbs: 0, fats: 0 });

                const typeHeader = document.createElement('h4');
                typeHeader.className = 'text-base font-bold text-text-default mt-4 mb-2 border-b-2 border-primary-light flex justify-between items-center';
                typeHeader.innerHTML = `
                    <span>${type}</span>
                    <span class="text-xs text-gray-500 font-normal">${mealsOfType.length} itens</span>
                `;
                foodLogEl.appendChild(typeHeader);

                const subtotalEl = document.createElement('div');
                subtotalEl.className = 'p-3 bg-primary-light rounded-lg shadow-sm mb-2 text-sm';
                subtotalEl.innerHTML = `
                    <p class="font-bold text-lg text-primary">${mealTotals.calories} kcal</p>
                    <p class="text-xs text-gray-700">
                        P: ${mealTotals.protein.toFixed(1)}g | 
                        C: ${mealTotals.carbs.toFixed(1)}g | 
                        G: ${mealTotals.fats.toFixed(1)}g
                    </p>
                `;
                foodLogEl.appendChild(subtotalEl);
                
                mealsOfType.forEach((meal) => {
                    const item = document.createElement('div');
                    const originalIndex = log.meals.findIndex(m => m === meal); 
                    
                    item.className = 'p-3 bg-card-bg rounded-lg shadow-sm border-l-4 border-blue-400 flex justify-between items-center';
                    item.innerHTML = `
                        <div>
                            <p class="font-semibold text-sm text-text-default">${meal.name}</p>
                            <p class="text-base font-extrabold text-blue-600">${meal.calories} kcal</p>
                            <p class="text-xs text-gray-500">P:${meal.protein}g | C:${meal.carbs}g | G:${meal.fats}g</p>
                        </div>
                        <button data-index="${originalIndex}" data-type="meal" data-date="${date}" class="delete-item-btn text-red-400 hover:text-red-600 p-2 rounded-full transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    `;
                    foodLogEl.appendChild(item);
                });
            }
        }

        if (date === appData.currentDate) {
            renderDailySummary();
        }
    }

    function getWeightForDate(date) {
        const entry = appData.weightHistory.find(w => w.date === date);
        return entry ? entry.weight : null;
    }

    function renderProgress() {
        // ... (Corpo da fun√ß√£o renderProgress)
        const date = document.getElementById('weight-date-select').value;
        const displayEl = document.getElementById('selected-weight-display');
        const weight = getWeightForDate(date);

        if (weight !== null) {
            displayEl.innerHTML = `Peso Registrado em ${formatDisplayDate(date)}: <span class="text-weight-color">${weight} kg</span>`;
        } else {
            displayEl.textContent = `Nenhum peso registrado para ${formatDisplayDate(date)}.`;
        }
        
        renderWeightChart();
        renderCalorieChart();
        const selectedExercise = document.getElementById('strength-exercise-select').value;
        renderStrengthChart(selectedExercise);
    }

    function renderStrengthChart(exerciseName) {
        // ... (Corpo da fun√ß√£o renderStrengthChart)
        const ctx = document.getElementById('strengthChart').getContext('2d');
        const displayEl = document.getElementById('current-pr-display');

        if (strengthChartInstance) {
            strengthChartInstance.destroy();
        }
        
        if (!exerciseName || !appData.prHistory[exerciseName] || appData.prHistory[exerciseName].length === 0) {
             displayEl.textContent = !exerciseName ? 'Selecione um exerc√≠cio para ver a progress√£o.' : 'Nenhum PR registrado para este exerc√≠cio.';
             return;
        }
        
        const history = appData.prHistory[exerciseName];
        
        const currentPR = history[history.length - 1];
        displayEl.innerHTML = `PR Atual: <span class="text-strength-color">${currentPR.load} kg</span> x ${currentPR.reps} reps (Volume: ${currentPR.volume.toFixed(0)})`;


        const labels = history.map(pr => new Date(pr.date + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' }));
        const loads = history.map(pr => pr.load);

        strengthChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: `Carga (kg) - ${exerciseName}`,
                    data: loads,
                    borderColor: '#9333EA',
                    backgroundColor: 'rgba(147, 51, 234, 0.1)',
                    tension: 0.3,
                    fill: false,
                    pointBackgroundColor: '#9333EA',
                    pointRadius: 6,
                    pointHoverRadius: 10,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Carga (kg)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                const index = context.dataIndex;
                                const prEntry = history[index];
                                let label = context.dataset.label || '';
                                label += `: ${prEntry.load} kg x ${prEntry.reps} reps`;
                                label += ` (Vol: ${prEntry.volume.toFixed(0)})`;
                                return label;
                            }
                        }
                    },
                }
            }
        });
    }

    function renderWeightChart() {
        // ... (Corpo da fun√ß√£o renderWeightChart)
        const ctx = document.getElementById('weightChart').getContext('2d');
        const sortedHistory = [...appData.weightHistory].sort((a, b) => new Date(a.date) - new Date(b.date));
        
        const labels = sortedHistory.map(w => new Date(w.date + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' }));
        const weights = sortedHistory.map(w => w.weight);
        
        const selectedDate = document.getElementById('weight-date-select').value;
        const pointBackgroundColors = sortedHistory.map(w => w.date === selectedDate ? 'rgb(59, 130, 246)' : 'rgba(59, 130, 246, 0.5)');
        const pointRadii = sortedHistory.map(w => w.date === selectedDate ? 8 : 5);


        if (weightChartInstance) {
            weightChartInstance.destroy();
        }

        weightChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Peso Corporal (kg)',
                    data: weights,
                    borderColor: '#3B82F6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.3,
                    fill: true,
                    pointBackgroundColor: pointBackgroundColors,
                    pointRadius: pointRadii,
                    pointHoverRadius: 10,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Peso (kg)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    },
                }
            },
            plugins: [{
                id: 'customDatalabels',
                afterDraw: function(chart) {
                    const ctx = chart.ctx;
                    const dataset = chart.data.datasets[0];
                    const meta = chart.getDatasetMeta(0);
                    
                    if (!meta.hidden && dataset.data.length > 0) {
                        meta.data.forEach((element, index) => {
                            if (sortedHistory[index].date === selectedDate) {
                                const value = dataset.data[index].toFixed(1) + ' kg';
                                const x = element.x;
                                const y = element.y;
                                
                                ctx.fillStyle = 'black';
                                ctx.font = 'bold 12px Inter, sans-serif';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'bottom';
                                ctx.fillText(value, x, y - 10);
                            }
                        });
                    }
                }
            }]
        });
    }

    function renderCalorieChart() {
        // ... (Corpo da fun√ß√£o renderCalorieChart)
        const ctx = document.getElementById('calorieChart').getContext('2d');
        const NUM_DAYS = 30;
        const labels = [];
        const calorieData = [];
        const today = new Date();

        for (let i = NUM_DAYS - 1; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(today.getDate() - i);
            const isoDate = date.toISOString().split('T')[0];
            
            const log = appData.dailyLogs[isoDate];
            const consumed = log ? log.meals.reduce((sum, meal) => sum + meal.calories, 0) : 0;
            const burned = log ? log.workouts.reduce((sum, ex) => {
                if (ex.category === 'Cardio') {
                    const match = ex.name.match(/\(([\d]+)\sKcal\)/);
                    return sum + (match ? parseInt(match[1]) : 0);
                } else {
                    return sum + estimateStrengthWorkoutCalories(ex.sets, ex.reps, ex.load);
                }
            }, 0) : 0;
            
            const balance = consumed - appData.calorieGoal + burned;

            labels.push(date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' }));
            calorieData.push(balance);
        }

        if (calorieChartInstance) {
            calorieChartInstance.destroy();
        }

        calorieChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Balan√ßo Cal√≥rico (kcal)',
                    data: calorieData,
                    backgroundColor: calorieData.map(val => val > 0 ? '#EF4444' : '#10B981'), // Vermelho para excedente, Verde para d√©ficit
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Balan√ßo (Consumido - Meta + Queimado)'
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 0,
                            minRotation: 0,
                            callback: function(value, index, values) {
                                return index % 5 === 0 ? this.getLabelForValue(value) : '';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y > 0) {
                                    label += `+${context.parsed.y} kcal (Excedente)`;
                                } else if (context.parsed.y < 0) {
                                    label += `${context.parsed.y} kcal (D√©ficit)`;
                                } else {
                                    label += '0 kcal (Na Meta)';
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderSettings() {
        // ... (Corpo da fun√ß√£o renderSettings)
        document.getElementById('current-goal-display').textContent = `Meta Atual: ${appData.calorieGoal} kcal`;

        document.getElementById('macro-goal-message').innerHTML = 
            `<span class="font-bold text-blue-500">P: ${appData.proteinGoal}g | C: ${appData.carbsGoal}g | G: ${appData.fatsGoal}g</span>`;
        
        document.getElementById('protein-goal-input').value = appData.proteinGoal;
        document.getElementById('carbs-goal-input').value = appData.carbsGoal;
        document.getElementById('fats-goal-input').value = appData.fatsGoal;


        document.getElementById('calc-gender').value = appData.calcInputs.gender || '';
        document.getElementById('calc-age').value = appData.calcInputs.age || '';
        document.getElementById('calc-height').value = appData.calcInputs.height || '';
        document.getElementById('calc-weight').value = appData.calcInputs.weight || '';
        document.getElementById('calc-activity').value = appData.calcInputs.activity || '';

        document.getElementById('tdee-results').classList.add('hidden');
        document.getElementById('result-bmr').textContent = 'BMR (Metabolismo Basal): -';
        document.getElementById('result-tdee').textContent = 'TDEE: 0 kcal/dia';
        document.getElementById('result-message').textContent = 'Calcule sua meta cal√≥rica.';
    }

    function setupExerciseForms() {
        // ... (Corpo da fun√ß√£o setupExerciseForms)
        const categorySelect = document.getElementById('exercise-category');
        const nameSelect = document.getElementById('exercise-name');
        const strengthSelect = document.getElementById('strength-exercise-select');
        const lastPrDisplay = document.getElementById('last-pr-display');

        categorySelect.innerHTML = '<option value="">Selecione a Categoria</option>';
        strengthSelect.innerHTML = '<option value="">Selecione um Exerc√≠cio...</option>';

        let strengthExercises = [];
        
        Object.keys(EXERCISE_DATABASE).forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);

            if (category !== 'Cardio') {
                strengthExercises.push(...EXERCISE_DATABASE[category]);
            }
        });
        
        strengthExercises.sort().forEach(exerciseName => {
            const option = document.createElement('option');
            option.value = exerciseName;
            option.textContent = exerciseName;
            strengthSelect.appendChild(option);
        });
        
        strengthSelect.addEventListener('change', function() {
            renderStrengthChart(this.value);
        });

        categorySelect.addEventListener('change', () => {
            const selectedCategory = categorySelect.value;
            
            nameSelect.innerHTML = '<option value="">Selecione o Exerc√≠cio</option>';
            nameSelect.disabled = true;
            document.getElementById('exercise-load').value = 0; // Reset load on category change
            lastPrDisplay.innerHTML = `<span class="text-xs text-gray-400">Selecione o exerc√≠cio para carregar o √∫ltimo registro.</span>`;

            if (selectedCategory && EXERCISE_DATABASE[selectedCategory]) {
                EXERCISE_DATABASE[selectedCategory].forEach(exerciseName => {
                    const option = document.createElement('option');
                    option.value = exerciseName;
                    option.textContent = exerciseName;
                    nameSelect.appendChild(option);
                });
                nameSelect.disabled = false;
            }
        });
        
        nameSelect.addEventListener('change', () => {
            const exerciseName = nameSelect.value;
            const lastEntry = getLastExerciseEntry(exerciseName);

            const setsInput = document.getElementById('exercise-sets');
            const repsInput = document.getElementById('exercise-reps');
            const loadInput = document.getElementById('exercise-load');

            if (lastEntry) {
                setsInput.value = lastEntry.sets;
                repsInput.value = lastEntry.reps;
                loadInput.value = lastEntry.load;
                lastPrDisplay.innerHTML = `<span class="text-xs text-blue-500">√öltimo Reg: ${lastEntry.load}kg x ${lastEntry.reps} (${lastEntry.sets} sets)</span>`;
            } else {
                setsInput.value = 4;
                repsInput.value = 10;
                loadInput.value = 0;
                lastPrDisplay.innerHTML = `<span class="text-xs text-gray-400">Nenhum registro anterior.</span>`;
            }
        });
    }
    
    function setupMealTemplateForms() {
        // ... (Corpo da fun√ß√£o setupMealTemplateForms)
        const templateSelector = document.getElementById('template-selector');
        templateSelector.innerHTML = '<option value="">Selecione um Prato Salvo</option>';
        
        Object.keys(appData.mealTemplates).sort().forEach(templateName => {
            const option = document.createElement('option');
            option.value = templateName;
            option.textContent = templateName;
            templateSelector.appendChild(option);
        });

        const datalistManager = document.getElementById('food-list-manager');
        const datalistOriginal = document.getElementById('food-list');
        if (datalistManager && datalistOriginal) {
            datalistManager.innerHTML = datalistOriginal.innerHTML;
        } else {
            console.error("Erro: Elementos datalist n√£o encontrados no DOM.");
        }
        
        const templateFoodInput = document.getElementById('template-food-name');
        if(templateFoodInput) {
            templateFoodInput.addEventListener('input', () => {
                const foodName = templateFoodInput.value.trim();
                const foodInfo = FULL_FOOD_DATABASE[foodName];
                const unitDisplay = document.getElementById('template-food-unit-display');
                if (unitDisplay) {
                    if (foodInfo) {
                        unitDisplay.value = foodInfo.unit || 'g';
                    } else {
                        unitDisplay.value = 'Unidade';
                    }
                }
            });
        }
    }


    function setupFoodForms() {
        // ... (Corpo da fun√ß√£o setupFoodForms)
        const datalist = document.getElementById('food-list');
        const foodNameInput = document.getElementById('food-name-input');
        const quantityInput = document.getElementById('food-quantity');

        if (datalist) {
            datalist.innerHTML = '';
            Object.keys(FULL_FOOD_DATABASE).sort().forEach(foodName => {
                const option = document.createElement('option');
                option.value = foodName;
                datalist.appendChild(option);
            });
        }

        function updateFoodCalculation() {
            const foodName = foodNameInput.value.trim();
            const quantity = parseFloat(quantityInput.value) || 0;
            const foodInfo = FULL_FOOD_DATABASE[foodName];
            
            let kcal = 0;
            let p = 0;
            let c = 0;
            let g = 0;

            if (foodInfo && quantity > 0) {
                const portionBase = foodInfo.portion || 100; 
                
                const multiplier = quantity / portionBase;
                kcal = Math.round(foodInfo.calories * multiplier);
                p = (foodInfo.protein * multiplier).toFixed(1);
                c = (foodInfo.carbs * multiplier).toFixed(1);
                g = (foodInfo.fats * multiplier).toFixed(1);
            }

            document.getElementById('preview-calories').textContent = `${kcal} kcal`;
            document.getElementById('preview-protein').textContent = p;
            document.getElementById('preview-carbs').textContent = c;
            document.getElementById('preview-fats').textContent = g;
        }

        if (foodNameInput && quantityInput) {
            foodNameInput.addEventListener('input', updateFoodCalculation);
            quantityInput.addEventListener('input', updateFoodCalculation);
            updateFoodCalculation();
        }
    }

    function changeTab(tabName) {
        // ... (Corpo da fun√ß√£o changeTab)
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'none';
        });

        document.querySelectorAll('.nav-icon').forEach(icon => {
            icon.classList.remove('active');
        });

        const activeContent = document.getElementById(`tab-${tabName}`);
        if (activeContent) {
            activeContent.style.display = 'block';
            
            if (tabName === 'workouts') renderWorkouts();
            if (tabName === 'food') renderFood();
            if (tabName === 'progress') renderProgress(); 
            if (tabName === 'settings') renderSettings();
        }

        document.querySelector(`.nav-icon[data-tab="${tabName}"]`).classList.add('active');
        document.getElementById('daily-summary').style.display = (tabName === 'settings' ? 'none' : 'block');
    }
    
    function renderTemplateComposition() {
        // ... (Corpo da fun√ß√£o renderTemplateComposition)
        const compositionList = document.getElementById('template-composition-list');
        const totalItemsEl = document.getElementById('template-total-items');
        compositionList.innerHTML = '';
        
        if (appData.templateEditorStaging.length === 0) {
            compositionList.innerHTML = '<p class="text-gray-500 text-sm text-center p-2">Nenhum item adicionado.</p>';
        } else {
            appData.templateEditorStaging.forEach((item, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'flex justify-between items-center bg-gray-50 p-2 rounded-lg text-sm border-b';
                itemEl.innerHTML = `
                    <p class="font-medium text-text-default">${item.name}</p>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-600">${item.quantity} ${item.unit}</span>
                        <button type="button" data-index="${index}" class="remove-template-item text-red-500 hover:text-red-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                `;
                compositionList.appendChild(itemEl);
            });
        }
        totalItemsEl.textContent = `${appData.templateEditorStaging.length} itens`;
    }

    function openTemplateManager(templateName = null) {
        // ... (Corpo da fun√ß√£o openTemplateManager)
        const modal = document.getElementById('template-manager-modal');
        const nameInput = document.getElementById('template-name-input');
        const deleteBtn = document.getElementById('delete-template-btn');
        
        appData.templateEditorStaging = [];
        nameInput.value = '';
        nameInput.dataset.originalName = '';
        
        if (templateName && appData.mealTemplates.hasOwnProperty(templateName)) {
            nameInput.value = templateName;
            nameInput.dataset.originalName = templateName;
            appData.templateEditorStaging = [...appData.mealTemplates[templateName]];
            deleteBtn.classList.remove('hidden');
        } else {
            deleteBtn.classList.add('hidden');
        }

        renderTemplateComposition();
        document.getElementById('template-manager-message').textContent = '';
        modal.classList.remove('hidden');
    }

    // --- MANIPULADORES DE EVENTOS DE FORMUL√ÅRIO (REFINADOS) ---
    
    // Listener do Formul√°rio de Exerc√≠cios (com valida√ß√£o estrita)
    document.getElementById('add-exercise-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const date = document.getElementById('workout-date-select').value;
        const category = document.getElementById('exercise-category').value;
        const name = document.getElementById('exercise-name').value;
        const sets = parseInt(document.getElementById('exercise-sets').value);
        const reps = parseInt(document.getElementById('exercise-reps').value);
        const load = parseFloat(document.getElementById('exercise-load').value);
        
        // Valida√ß√£o estrita
        if (!category || !name) {
            showMessage('exercise-form-message', 'Erro: Selecione a categoria e o exerc√≠cio.', 'text-red-500');
            return;
        }
        if (isNaN(sets) || sets <= 0 || isNaN(reps) || reps <= 0 || isNaN(load) || load < 0) {
            showMessage('exercise-form-message', 'Erro: S√©ries, Reps e Carga devem ser n√∫meros v√°lidos (‚â• 0).', 'text-red-500');
            return;
        }

        const dayLog = getCurrentDayLog(date);
        
        // Adicionar novo exerc√≠cio
        const newExercise = { category, name, sets, reps, load };
        dayLog.workouts.push(newExercise);
        dayLog.isWorkoutDone = true;

        // Atualizar PR (apenas para exerc√≠cios de for√ßa)
        if (category !== 'Cardio') {
            updatePR(name, date, load, reps);
        }

        saveData();
        renderWorkouts();
        
        // Limpar formul√°rio (mantendo a categoria) e mostrar sucesso
        document.getElementById('exercise-name').value = '';
        document.getElementById('exercise-sets').value = 4;
        document.getElementById('exercise-reps').value = 10;
        document.getElementById('exercise-load').value = 0;
        
        showMessage('exercise-form-message', 'Exerc√≠cio registrado com sucesso!', 'text-primary');
    });

    // NOVO Listener do Formul√°rio para Adicionar Refei√ß√£o/Alimento
    document.getElementById('add-meal-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const date = document.getElementById('food-date-select').value;
        const mealType = document.getElementById('meal-type').value;
        const foodName = document.getElementById('food-name-input').value.trim();
        const quantity = parseFloat(document.getElementById('food-quantity').value);
        const messageEl = document.getElementById('meal-form-message');

        // Valida√ß√£o
        if (!mealType) {
            showMessage('meal-form-message', 'Erro: Selecione o tipo de refei√ß√£o.', 'text-red-500');
            return;
        }
        const foodInfo = FULL_FOOD_DATABASE[foodName];
        if (!foodInfo) {
            showMessage('meal-form-message', 'Erro: Alimento n√£o encontrado na lista.', 'text-red-500');
            return;
        }
        if (isNaN(quantity) || quantity <= 0) {
            showMessage('meal-form-message', 'Erro: Quantidade inv√°lida.', 'text-red-500');
            return;
        }

        // C√°lculo e Registro
        const multiplier = quantity / (foodInfo.portion || 100);
        const newMeal = {
            type: mealType,
            name: foodName,
            quantity: quantity,
            unit: foodInfo.unit || 'g',
            calories: Math.round(foodInfo.calories * multiplier),
            protein: parseFloat((foodInfo.protein * multiplier).toFixed(1)),
            carbs: parseFloat((foodInfo.carbs * multiplier).toFixed(1)),
            fats: parseFloat((foodInfo.fats * multiplier).toFixed(1))
        };

        const dayLog = getCurrentDayLog(date);
        dayLog.meals.push(newMeal);

        saveData();
        renderFood();
        
        // Limpar formul√°rio (mantendo o tipo de refei√ß√£o)
        document.getElementById('food-name-input').value = '';
        document.getElementById('food-quantity').value = 100;
        
        showMessage('meal-form-message', `${newMeal.name} registrado em ${mealType}.`, 'text-primary');
    });

    // NOVO Listener do Formul√°rio para Carregar Template
    document.getElementById('load-template-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const date = document.getElementById('food-date-select').value;
        const templateName = document.getElementById('template-selector').value;
        
        if (!templateName) {
            showMessage('meal-form-message', 'Erro: Selecione um prato template para carregar.', 'text-red-500');
            return;
        }

        const template = appData.mealTemplates[templateName];

        if (!template || template.length === 0) {
            showMessage('meal-form-message', `Erro: Template "${templateName}" est√° vazio ou n√£o existe.`, 'text-red-500');
            return;
        }

        const dayLog = getCurrentDayLog(date);
        
        const defaultMealType = 'Lanche/Outros'; 
        let loadedCount = 0;

        template.forEach(item => {
            const foodInfo = FULL_FOOD_DATABASE[item.name];

            if (foodInfo && item.quantity > 0) {
                const multiplier = item.quantity / (foodInfo.portion || 100);
                
                const newMeal = {
                    type: defaultMealType, // Define um tipo padr√£o
                    name: item.name,
                    quantity: item.quantity,
                    unit: item.unit,
                    calories: Math.round(foodInfo.calories * multiplier),
                    protein: parseFloat((foodInfo.protein * multiplier).toFixed(1)),
                    carbs: parseFloat((foodInfo.carbs * multiplier).toFixed(1)),
                    fats: parseFloat((foodInfo.fats * multiplier).toFixed(1))
                };
                dayLog.meals.push(newMeal);
                loadedCount++;
            }
        });

        saveData();
        renderFood();
        
        document.getElementById('template-selector').value = '';

        if (loadedCount > 0) {
            showMessage('meal-form-message', `Template "${templateName}" carregado! (${loadedCount} itens)`, 'text-primary');
        } else {
            showMessage('meal-form-message', `Aviso: Template carregado, mas nenhum item v√°lido adicionado.`, 'text-red-500');
        }
    });


    // Listener do bot√£o de "Gerenciar Pratos"
    if (document.getElementById('open-template-manager')) {
        document.getElementById('open-template-manager').addEventListener('click', () => {
            const templateSelector = document.getElementById('template-selector');
            const selectedTemplate = templateSelector.value;
            // Carrega o prato selecionado no dropdown, ou abre um novo
            openTemplateManager(selectedTemplate || null); 
        });
    }

    // Listener do bot√£o de "Fechar" no modal
    if (document.getElementById('close-template-manager')) {
        document.getElementById('close-template-manager').addEventListener('click', () => {
            document.getElementById('template-manager-modal').classList.add('hidden');
            // Re-renderiza o log de comida para garantir que o dropdown est√° atualizado
            renderFood();
        });
    }

    // A√ß√µes de Carregamento para Edi√ß√£o: Quando o usu√°rio digita o nome
    if (document.getElementById('template-name-input')) {
        document.getElementById('template-name-input').addEventListener('input', function() {
            const name = this.value.trim();
            const deleteBtn = document.getElementById('delete-template-btn');
            
            // Verifica se o nome digitado corresponde a um template existente
            const isCurrentlyEditing = appData.mealTemplates.hasOwnProperty(name);

            if (isCurrentlyEditing) {
                // Carrega os itens do template existente para o staging area
                appData.templateEditorStaging = [...appData.mealTemplates[name]];
                renderTemplateComposition();
                deleteBtn.classList.remove('hidden');
            } else if (name.length === 0) {
                 // Campo vazio, limpa tudo no modal
                 appData.templateEditorStaging = [];
                 renderTemplateComposition();
                 deleteBtn.classList.add('hidden');
            } else {
                deleteBtn.classList.add('hidden');
            }
        });
    }
    
    // Listener para o novo alimento personalizado (Mantido)
    document.getElementById('add-custom-food-form').addEventListener('submit', function(e) {
        // ... (c√≥digo existente)
        e.preventDefault();
        
        const nameInput = document.getElementById('custom-food-name');
        const caloriesInput = document.getElementById('custom-food-calories');
        const proteinInput = document.getElementById('custom-food-protein');
        const carbsInput = document.getElementById('custom-food-carbs');
        const fatsInput = document.getElementById('custom-food-fats');
        const unitInput = document.getElementById('custom-food-unit');

        const newFoodName = nameInput.value.trim();
        const newCalories = parseInt(caloriesInput.value);
        const newProtein = parseFloat(proteinInput.value);
        const newCarbs = parseFloat(carbsInput.value);
        const newFats = parseFloat(fatsInput.value);
        
        if (!newFoodName) {
            showMessage('custom-food-message', 'Erro: O nome do alimento √© obrigat√≥rio.', 'text-red-500');
            return;
        }
        if (FULL_FOOD_DATABASE.hasOwnProperty(newFoodName)) {
            showMessage('custom-food-message', 'Erro: Alimento j√° existe. Use um nome √∫nico.', 'text-red-500');
            return;
        }
        if (isNaN(newCalories) || newCalories < 0 || isNaN(newProtein) || newProtein < 0 || isNaN(newCarbs) || newCarbs < 0 || isNaN(newFats) || newFats < 0) {
            showMessage('custom-food-message', 'Erro: Todos os valores nutricionais devem ser n√∫meros v√°lidos (‚â• 0).', 'text-red-500');
            return;
        }

        const newFoodData = {
            calories: newCalories,
            protein: newProtein,
            carbs: newCarbs,
            fats: newFats,
            unit: unitInput.value.trim() || 'g',
            portion: 100,
            category: 'Personalizado'
        };

        let userFoods = {};
        try {
            const storedFoods = localStorage.getItem(USER_FOODS_KEY);
            if (storedFoods) {
                userFoods = JSON.parse(storedFoods);
            }
        } catch (error) { /* Ignora se estiver vazio */ }

        userFoods[newFoodName] = newFoodData;

        localStorage.setItem(USER_FOODS_KEY, JSON.stringify(userFoods));
        mergeFoodDatabases();

        setupFoodForms(); 
        setupMealTemplateForms();
        
        showMessage('custom-food-message', `Alimento "${newFoodName}" adicionado com sucesso!`, 'text-primary');
        this.reset();
    });

    // Listener para Adicionar Item ao Template (no modal)
    if (document.getElementById('add-item-to-template')) {
        document.getElementById('add-item-to-template').addEventListener('click', () => {
            const foodName = document.getElementById('template-food-name').value.trim();
            const quantity = parseFloat(document.getElementById('template-food-quantity').value);
            const foodInfo = FULL_FOOD_DATABASE[foodName];
            
            if (!foodName || !foodInfo) {
                showMessage('template-manager-message', 'Erro: Selecione um alimento v√°lido da lista.', 'text-red-500');
                return;
            }
            if (isNaN(quantity) || quantity <= 0) {
                showMessage('template-manager-message', 'Erro: Quantidade inv√°lida.', 'text-red-500');
                return;
            }

            const newItem = {
                name: foodName,
                quantity: quantity,
                unit: foodInfo.unit || 'g'
            };

            appData.templateEditorStaging.push(newItem);
            renderTemplateComposition();
            
            document.getElementById('template-food-name').value = '';
            document.getElementById('template-food-quantity').value = 100;
            document.getElementById('template-food-unit-display').value = 'Unidade';
            showMessage('template-manager-message', 'Item adicionado ao prato!', 'text-blue-500');
        });
    }

    // Listener para Salvar Prato (no modal)
    document.getElementById('template-editor-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const templateName = document.getElementById('template-name-input').value.trim();
        
        if (!templateName) {
            showMessage('template-manager-message', 'Erro: O nome do prato √© obrigat√≥rio.', 'text-red-500');
            return;
        }

        if (appData.templateEditorStaging.length === 0) {
            showMessage('template-manager-message', 'Erro: O prato deve ter pelo menos um item.', 'text-red-500');
            return;
        }

        appData.mealTemplates[templateName] = appData.templateEditorStaging;
        saveData();
        setupMealTemplateForms();

        showMessage('template-manager-message', `Prato "${templateName}" salvo/atualizado com sucesso!`, 'text-primary');
        document.getElementById('template-name-input').dataset.originalName = templateName; // Marca como editado
    });

    // Listener para Deletar Prato (no modal)
    document.getElementById('delete-template-btn').addEventListener('click', () => {
        const templateName = document.getElementById('template-name-input').value.trim();

        if (templateName && appData.mealTemplates.hasOwnProperty(templateName)) {
            // Usando um modal simulado simples para confirma√ß√£o
            const confirmation = document.createElement('div');
            confirmation.className = "fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4";
            confirmation.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                    <p class="text-lg font-bold mb-4">Confirmar Exclus√£o</p>
                    <p class="mb-6">Tem certeza que deseja apagar o prato "${templateName}"?</p>
                    <div class="flex justify-end gap-3">
                        <button id="modal-cancel" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancelar</button>
                        <button id="modal-confirm" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Confirmar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmation);

            document.getElementById('modal-confirm').addEventListener('click', () => {
                delete appData.mealTemplates[templateName];
                saveData();
                setupMealTemplateForms();
                openTemplateManager(null); // Fecha e abre em modo novo
                document.body.removeChild(confirmation);
                showMessage('template-manager-message', `Prato deletado.`, 'text-red-500');
            });
            document.getElementById('modal-cancel').addEventListener('click', () => {
                document.body.removeChild(confirmation);
            });
        } else {
            showMessage('template-manager-message', 'Erro: Nenhum prato v√°lido selecionado para deletar.', 'text-red-500');
        }
    });

    // NOVO: DELEGA√á√ÉO DE EVENTOS PARA ITENS DO TEMPLATE STAGING
    document.getElementById('template-composition-list').addEventListener('click', function(e) {
        if (e.target.closest('.remove-template-item')) {
            const button = e.target.closest('.remove-template-item');
            const index = parseInt(button.dataset.index);
            
            if (!isNaN(index) && index >= 0 && index < appData.templateEditorStaging.length) {
                appData.templateEditorStaging.splice(index, 1);
                renderTemplateComposition(); // Re-renderiza a lista de itens
                showMessage('template-manager-message', 'Item removido do prato.', 'text-blue-500');
            }
        }
    });

    // Listener delegado para exclus√£o de refei√ß√µes e treinos
    document.getElementById('content-area').addEventListener('click', function(e) {
        if (e.target.closest('.delete-item-btn')) {
            const button = e.target.closest('.delete-item-btn');
            const index = parseInt(button.dataset.index);
            const type = button.dataset.type; // 'meal' or 'workout'
            const date = button.dataset.date;

            const targetElement = type === 'meal' ? 'meal-form-message' : 'exercise-form-message';
            const itemType = type === 'meal' ? 'refei√ß√£o' : 'exerc√≠cio';
            
            if (!date || isNaN(index)) {
                 showMessage(targetElement, `Erro: Falha ao identificar o item de ${itemType}.`, 'text-red-500');
                 return;
            }

            // Simula√ß√£o de modal de confirma√ß√£o para exclus√£o de item individual
            const confirmation = document.createElement('div');
            confirmation.className = "fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4";
            confirmation.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                    <p class="text-lg font-bold mb-4">Confirmar Exclus√£o</p>
                    <p class="mb-6">Tem certeza que deseja apagar este ${itemType}?</p>
                    <div class="flex justify-end gap-3">
                        <button id="modal-cancel-item" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancelar</button>
                        <button id="modal-confirm-item" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Confirmar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmation);

            document.getElementById('modal-confirm-item').addEventListener('click', () => {
                const dayLog = getCurrentDayLog(date);
                
                if (type === 'meal') {
                    dayLog.meals.splice(index, 1);
                    saveData();
                    renderFood();
                } else if (type === 'workout') {
                    dayLog.workouts.splice(index, 1);
                    dayLog.isWorkoutDone = dayLog.workouts.length > 0;
                    saveData();
                    renderWorkouts();
                }
                
                document.body.removeChild(confirmation);
                showMessage(targetElement, `${itemType} exclu√≠do.`, 'text-red-500');
            });
            document.getElementById('modal-cancel-item').addEventListener('click', () => {
                document.body.removeChild(confirmation);
            });
        }
    });

    // --- INICIALIZA√á√ÉO ---
    document.addEventListener('DOMContentLoaded', () => {
        
        loadData();

        // Configura os formul√°rios (deve ser feito ap√≥s o loadData)
        setupExerciseForms();
        setupFoodForms(); 
        setupMealTemplateForms(); // Carrega os templates de refei√ß√£o

        // Adiciona listeners para os bot√µes de navega√ß√£o
        document.querySelectorAll('.nav-icon').forEach(button => {
            button.addEventListener('click', () => {
                const tab = button.getAttribute('data-tab');
                changeTab(tab);
            });
        });

        // Inicializa na aba de Treinos
        changeTab('workouts');
    });
</script>

<!-- REGISTRO DO SERVICE WORKER PWA -->
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./service-worker.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                })
                .catch(error => {
                    console.log('ServiceWorker registration failed: ', error);
                });
        });
    }
</script>

</body>
</html>
